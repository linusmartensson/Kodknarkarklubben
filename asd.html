<script type=t id=v>attribute vec2 a;void main(){gl_Position=vec4(a*2.0-1.0,0.5,1.0);}</script><script type=t id=f>
precision mediump float; 
uniform vec2 res; 
uniform float t;
uniform float xpos;
uniform float xacc;

vec3 o;



float rand(float a){
	return fract(mod(a*90327.12312+1230.0,(sin(a)+1.0)*10351.023));
}

float noise(float a){
	return mix(rand(floor(a)-1.0), rand(floor(a)), 1.0-(cos(fract(a)*3.14159)*0.5+0.5));
}


void rot(inout vec2 v, in float t){
	float c = cos(t);
	float s = sin(t);
	v *= mat2(c, -s, s, c);
}


float groundheight(vec3 pos){
	return pos.y + 
		-10.0+noise(pos.z*0.003)*30.0
		     +noise(pos.x*0.003)*30.0;
}

float box(vec3 p, vec3 b){
	vec3 d = abs(p) - b;
	return min(max(d.x,max(d.y,d.z)),0.0) + length(max(d,0.0));
}

float cylinder(vec3 p, float w){
	return length(p.xz)-w;
}


#define STARTSPEED 10.0

float ship(vec3 p){

	vec3 oo = vec3(xpos,7.3,-20.0+t*STARTSPEED+t*t+5.0);

	oo.y -= groundheight(oo)-3.5;

	vec3 po = p-oo;


	rot(po.zy, 0.1);
	rot(po.xz, xacc*0.1);
	rot(po.yx, xacc*-0.3);
	vec3 poo = po;
	vec3 pooo = po+vec3(0.0,0.0,-4.0);
	rot(po.yx, 3.14159-0.3);
	float mm = (po.z)*0.2;
	float p1 = box(po, vec3(2.0,0.3,3.0));
	rot(po.yx, 3.14159+0.6);
	float p2 = box(po, vec3(2.0,0.3,3.0));


	float k = 1.0;

	rot(poo.xz, k);
	float p3 = box(poo, vec3(1.3,1.0,3.3));
	rot(poo.xz, -k*2.0);
	p3 = max(box(poo, vec3(1.3,1.0,3.3)),p3);
	
	return min(max(p3,min(p1,p2)), box(pooo, vec3(0.3,0.3,3.0)))+0.3;
}

float d(vec3 pos){
	
	vec3 p = pos;
	pos.x = mod(pos.x,120.0)-60.0;
	pos.z = mod(pos.z,10.0)-5.0;

 

	float rr = rand(floor(p.z/10.0));	


	float z = 100000000.0;

	z = min(cylinder(pos+vec3(100.0*rr-50.0,0.0,0.0),2.0),z);


	z = min(z,groundheight(p));

	pos.y = mod(pos.y-t*50.0*rr,100.0)-50.0;
	rot(pos.xy, 3.14159/4.0);



	z = min(distance(pos, vec3(rr*80.0-40.0,10.0,10.0))-10.0,z);

	return z;
}

float da(vec3 pp){
	return min(d(pp), ship(pp));	
}

vec3 norm(vec3 p){
	vec2 e = vec2(0.1,0.0);

	return normalize(vec3(
		da(p+e.xyy)-da(p-e.xyy),
		da(p+e.yxy)-da(p-e.yxy),
		da(p+e.yyx)-da(p-e.yyx)
			));
}


void main(){ 
	float l = 0.0;
	float tf = floor(t*0.25+10.0);
	o = vec3(xpos,0.0,-20.0+t*STARTSPEED+t*t);
	vec3 dir = vec3((gl_FragCoord.xy/res.xy*2.0-1.0)/vec2(res.y/res.x,1.0),1.0);

	rot(dir.xz,-(xacc*0.05));

	vec2 rd = vec2(atan(dir.x,dir.y), sqrt(dir.x*dir.x+dir.y*dir.y)*1.0);

	dir.xy = vec2(sin(rd.x)*rd.y, cos(rd.x)*rd.y);

	dir = normalize(dir);
	rot(dir.yx, xacc*0.05);

	o.y -= groundheight(o)-4.5;

	vec3 pp = vec3(0.0);


	float j = 0.0;
	gl_FragColor = vec4(0.0,0.0,0.0,1.0);
	float dt = 1.0; 
	for(int i=0;i<100;++i){
		if(dt < 0.025 || l > 350.0){
			continue;
		}
		j = float(i);
		pp = o+dir*l;
		dt = min(d(pp), ship(pp));
		l += dt*0.95;
		
	}
	gl_FragColor = vec3(0.0,noise(dir.y*10.0+dir.x*3.0)*0.1+0.9,1.0).xyyz*vec4(1.0,0.4,1.0,1.0);
	if(dt < 0.025) {
		vec3 n = norm(pp);
		gl_FragColor.rgb = mix(vec3(dot(n, vec3(1.0,0.0,0.0))),gl_FragColor.rgb, clamp(l/150.0,0.0,1.0));
	}
}
</script><div style="position:fixed;left:0;right:0;top:0;bottom:0;" ><canvas width=640 height=360 id=a style="width:100%;height:100%"/></div><script>
e=document;
d=function(a){return e.getElementById(a)}
l=function(a){console.log(a)};
x = 0.0
xa = 0.0
ml = false;
mr = false;
e.onkeydown = function(a){
	if(a.keyCode == 37) ml=true;
	if(a.keyCode == 39) mr=true;	
}
e.onkeyup = function(a){
	if(a.keyCode == 37) ml=false;
	if(a.keyCode == 39) mr=false;
}
c=d("a")
g=c.getContext("webgl")
v=g.createBuffer()
k=g.ARRAY_BUFFER
g.bindBuffer(k, v)
g.bufferData(k, new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,1.0,1.0]), g.STATIC_DRAW)
g.enableVertexAttribArray(0)
p=g.createProgram()
t=function(a,b,c){f=g.createShader(b);g.shaderSource(f,c);g.compileShader(f);g.attachShader(a,f);return g.getShaderInfoLog(f)}
l("VERT:"+t(p,g.VERTEX_SHADER,d("v").textContent))
l("FRAG:"+t(p,g.FRAGMENT_SHADER,d("f").textContent))
l(g.getProgramInfoLog(p));
g.linkProgram(p);
g.useProgram(p);
g.vertexAttribPointer(0, 2, g.FLOAT, 0, 0, 0);
t=0
m=function(a){
g.uniform2f(g.getUniformLocation(p, "res"), g.drawingBufferWidth,g.drawingBufferHeight);
t=t||a
g.uniform1f(g.getUniformLocation(p, "t"), (a-t)/1000+10.0)
g.uniform1f(g.getUniformLocation(p, "xpos"), x)
g.uniform1f(g.getUniformLocation(p, "xacc"), xa)
g.drawArrays(g.TRIANGLE_STRIP, 0, 4)
window.requestAnimationFrame(m)
}
setInterval(function(){
 if(ml) xa-=0.3;
 if(mr) xa+=0.3;
 xa *= 0.95;
 x += xa;
}, 16);

m(0)</script>
